\documentclass[main.tex]{subfiles}

\begin{document}
\section{Z80-processorn}
Z80:n kan delas upp i tre sektioner; kontroll, register och ALU. De är anslutna
med varandra via databussen, addressbussen och en del tunnlar.
Kontrollsektionen har även kontrollsignaler till alla delar av processorn.

\subsection{Kontrollsektion}
Kontrollsektionen består av tre komponenter; instruktionsregistret,
tillståndsmaskinen och instruktionsdekodaren. Tillståndsmaskinen lagrar och
ändrar hela processorns tillstånd, förutom alla registervärden. Utifrån
processorns tillstånd och instruktionregistrets värde aktiverar
instruktionsdekodaren, som endast är ett stort kombinatoriskt nät, olika
kontrollsignaler.

\subsubsection{Instruktionsregistret \mono{IR}}
\mono{IR} är det register som instruktioner direkt laddas till när de läses
från minnet. Här lagras de tills nästa instruktion laddas in. Om en instruktion
har ett prefix lagras först prefixet i \mono{IR} och skrivs kort därefter över
med ett nytt prefix eller en instruktion.

\subsubsection{Tillstånd}
Tillståndsmaskinen har fem olika tillståndsvariabler; läget \mono{mode},
avbrottsläget \mono{IM}, instruktionsprefixet \mono{prefix}, maskincykeln
\mono{M} och T-tillståndet \mono{T}.

\mono{T} är ett heltal mellan 1 och 6 som avgör vilken klockpuls av en
maskincykel processorn är i. En maskincykel kan bestå av 3 till 6 klockpulser.
Med andra ord ökas \mono{T} med 1 varje klockpuls förutom när processorn byter
maskincykel, då sätts \mono{T} till 1 igen.

\mono{M} är också ett heltal mellan 1 och 5 men som avgör vilken del av en
instruktion processorn består i. Vid instruktioner som består av flera ord
kommer maskincykeln gå tillbaka till 1 vid varje hämtning. Detta är för att
göra instruktionsdekodaren enklare. Instruktionshämtning sker därmed endast på
maskincykel 1. Det innebär dessutom att liknande instruktioner med olika prefix
kan återanvändas eftersom allas exekveringsfas börjar på maskincykel 1. Till
exempel instruktionerna \mono{ADD HL, SP} och \mono{ADD IX, SP}.
Instruktionernas objektkoder är \mono{39} respektive \mono{DD39}. Båda instruktioner är
identiska förutom att de har förskjutna maskincyklar och destinationsregistret
har olika addresser.

\begin{figure}[H]
    \center
    \begin{tabular}{|r|p{2cm}|p{2cm}|p{2cm}|p{2cm}|}
        \hline
        maskincykel & 1 & 2 & 3 & 4 \\ \hline
        \multicolumn{5}{l}{\mono{ADD HL, SP}} \\ \hline
        prefix      & \multicolumn{4}{l|}{\mono{main}} \\ \hline
        fas         & hämta 39 & addera låga & addera höga & färdig \\ \hline
        \multicolumn{5}{l}{\mono{ADD IX, SP}} \\ \hline
        prefix      & \mono{main} & \multicolumn{3}{l|}{\mono{DD}} \\ \hline
        fas         & hämta DD & hämta 39 & addera låga & addera höga \\ \hline
    \end{tabular}
\end{figure}

Genom att sätta maskincykeln till 1 vid andra hämtningen hamnar maskincyklarna
i fas och instruktionsdekodaren kan ge identiska kontrollsignaler för båda
instruktonerna utöver addressen till destinationsregistret.

Som ovan exempel visar används prefix-tillståndet tillsammans med \mono{IR} för att
avgöra vilken instruktion som ska exekveras. Det finns åtta olika prefix;
\mono{main} för huvudinstruktioner, \mono{ED} för utökade instruktioner,
\mono{CB} för bitinstruktioner, \mono{DD}/\mono{FD} för IX/IY-instruktioner,
\mono{DDCB}/\mono{FDCB} för IX/IY-bitinstruktioner samt \mono{int} som sätts
vid avbrott. Vid processorns start och efter varje instruktion sätts prefixet
till \mono{main}. Om \mono{IR} därefter laddas med en prefix-byte kommer
prefix-tillståndet att övergå till motsvarande prefix och maskincykeln sätts
till 1 så att hämtningsfasen börjar om på nytt. Därefter kan ett nytt prefix
eller en instruktion laddas. Om en instruktion laddas påbörjas dess exekvering
direkt. I ovan exempel är prefix-byten \mono{DD} och instruktions-byten
\mono{39}.

Det finns dessutom ett prefix som inte går att komma åt med ett prefix i
instruktionen. Det är \mono{int}-prefixet. Detta sätts alltid efter en
instruktion har avslutats om ett avbrott har skett. Om prefixet är \mono{int}
kommer instruktionsdekodaren inte exekvera någon instruktion utefter vad
\mono{IR} innehåller. Istället kommer den då alltid att köra en avbrottssekvens
utefter vad \mono{IM}-tillståndet är. \mono{IM}-tillståndet avgör det
nuvarande avbrottsläget och kan väljas av programmeraren med \mono{IM 0},
\mono{IM 1} och \mono{IM 2}-instruktionerna.

Det sista tillståndet i processorns tillståndsmaskin är \mono{mode} som kan
anta de tre olika tillstånden \mono{exec}, \mono{halt} och \mono{interrupt}.
Normalt sätt är processorn i \mono{exec}. Då kommer instruktionsdekodaren
exekvera instruktioner utefter \mono{IR}, prefixet och även \mono{IM}. I
\mono{halt} däremot kommer processorn fortsätta exekvera instruktioner men den
hämtar inte nya instruktioner under maskincykel 1. Normalt sätt hamnar
processorn i \mono{halt} från \mono{HALT}-instruktionen. När den avslutas
övergår processorn till \mono{halt}-läge och maskincykel 1 men eftersom den
inte hämtar en ny instruktion kommer den exekvera \mono{HALT} igen tills
processorn får ett avbrott eller återställs. Det sista läget är
\mono{interrupt} som väljs när ett avbrott sker. Anledningen till att det finns
ett \mono{interrupt}-läge och ett \mono{int}-prefix är för att även om ett
avbrott har skett kan en överlappande instruktion behöva exekvera färdigt innan
avbrottsekvensen körs. \mono{interrupt}-läget förhindrar dessutom att en ny
instruktion som inte ännu ska exekveras hämtas och att programräknaren inte
ökas innan den ska sparas till stacken.

\subsubsection{Kontrollsignaler}
Kontrollsignalerna är uppdelade i tre grupper; extern kontrollbus,
tillståndskontroll samt interna kontrollsignaler.

Den externa kontrollbussen har sex utsignaler som instruktionsdekodaren
aktiverar; \mono{M1}, \mono{MREQ}, \mono{IORQ}, \mono{RD} och \mono{WR}.
\mono{RD} och \mono{WR} används för att signalera läsning eller skrivning till
och från antingen minnet eller IO-portar. Processorn signalerar vilket med
hjälp av \mono{MREQ} och \mono{IORQ}. \mono{M1} används för att signalera om
CPU:n är i maskincykel 1. Om processorn läser från minnet under maskincykel 1
vet externa enheter att processorn hämtar en instruktion.

Kontrollsignalerna för tillståndsmaskinen avgör processorns nästa tillstånd.

\subsubsection{Faser}

\subsection{Register}
Registerna är strukturerade som ett blokram sammankopplat med en multiplexer.
Multiplexerns roll i symbiosen är att hantera vilket register som skall skrivas
till respektive läsas från. Varje register har en speciell kod som används för
att muxen ska hålla koll på vilket register som pekas på. Muxen väntar sedan på
en läs- eller skrivsignal för att avgöra vad som ska göras med registret som
pekas på. Kodningen som använts för registerna är baserad på Zilogs
originalkodning som beskrivs i användarmanualen \cite{userman}. Det som skiljer
kodningen som används från originalkodningen är att två extra siffror har lagts
till och att kodningen på vissa av registrerna har förändrats. Siffrorna längst
fram lades till eftersom det var fler register som skulle hållas koll på än
originalsiffrorna räckte för.

Kodningen är binär och består av fem siffror. De två mest signifikanta bitarna
används för att skilja på Zilogs originalkodning och de registerna som
egentligen inte var en del av kodningen som ändå skulle hållas koll på.

Som beskrivet i teori-delen så finns det både 8-bitars- och 16-bitarsregister i
strukturen. Strukturen ser ut som följande:

\begin{center}
    \begin{tabular}{ r|c|c|r }
        \multicolumn{1}{r}{addr}
        &  \multicolumn{1}{c}{high}
        & \multicolumn{1}{c}{low} 
        & \multicolumn{1}{l}{addr} \\
        \cline{2-3}
        00 00000 & \mono{B} & \mono{C} & 00001 01  \\
        \cline{2-3}
        02 00010 & \mono{B} & \mono{C} & 00011 03  \\
        \cline{2-3}
        04 00100 & \mono{D} & \mono{E} & 00101 05  \\
        \cline{2-3}
        06 00110 & \mono{D} & \mono{E} & 00111 07  \\
        \cline{2-3}
        08 01000 & \mono{H} & \mono{L} & 01001 09  \\
        \cline{2-3}
        10 01010 & \mono{H} & \mono{L} & 01011 11  \\
        \cline{2-3}
        12 01100 & \mono{A} & \mono{F} & 01101 13  \\
        \cline{2-3}
        14 01110 & \mono{A} & \mono{F} & 01111 15  \\
        \cline{2-3}
        16 10000 & \mono{W} & \mono{Z} & 10001 17  \\
        \cline{2-3}
    \end{tabular}\\
    \begin{tabular}{ r|p{0.2cm} c p{0.2cm}|l }
        18 10010 && \mono{SP} && 10011 19 \\
        \cline{2-4}
        20 10100 && \mono{IX} && 10011 21 \\
        \cline{2-4}
        22 10110 && \mono{IY} && 10111 23 \\
        \cline{2-4}
    \end{tabular}
\end{center}
 
Figuren visar att det även finns en dublett av varje register. Det är för att
en swap-funktion ska hanteras. Det swap-funktionen gör är att byta innehållet i
ett register med innehåller på dess ''prim''-variant, som är ett
likadant,internt register. Om man skapar två identiska register kan båda
dubletterna agera som både ''prim''-variant och original. Vilket som är vilket
urskiljs med hjälp av en pekare.

Varje register - förutom SP, IX och IY som är 16-bitarsregister - är
8-bitarsregister och har olika användningsområden. Register A är indirekt
kopplat till ALU:n och register F håller koll på flaggorna. Register W och Z är
endast interna register och kan användas för att lagra värden som ska användas
senare. I register C lagrar man värdena för vilken port som ska användas i IN
och OUT funktioner. Utöver dessa undantag kan alla register användas
likgiltigt. 8-bitarsregisterna kan även användas som 16-bitarsregister ifall de
paras ihop med sin andra halva. Vilka register som hör ihop med varandra kan
man se i figuren ovan.

\end{document}
